# 3.2 카프카 데이터 모델

생성일: 2021년 3월 13일 오전 3:31

카프카의 핵심

- 토픽: 메시지를 받을 수 있도록 논리적으로 묶은 개념
- 파티션: 토픽을 구성하는 데이터 저장소 → 수평확장 가능

# 1. 토픽의 이해

카프카 클러스터 → 토픽에 데이터 저장

ex) 메일시스템에서 메일주소가 토픽이라고 생각하면 쉽다 → 메일 서버에 여러가지 메시지가 마구 섞여서 내가 찾고 싶은 메시지가 찾기 어려울때 메일주소로 구분해 저장하면 찾기 쉬움

### 토픽별 메시징

- 뉴스 프로듀서 → 뉴스 토픽으로 메시지전송
- 동영상 프로듀서→ 동영상 토픽으로 메시지 전송

뉴스 관련 내용만 보고 싶을때, 뉴스 토픽에 컨슈머를 연결해 메시지를 갖고옴

### 카프카의 토픽 이름 규칙

토픽 이름 앞에 접두어로 서비스 명을 추가해서 다른 서비스와의 토픽이름 중복 피하기

sbs-news

sbs-video

kbs-news

kbs-video

# 2. 파티션의 이해

카프카에서 파티션 : 토픽을 분할한 것

### 파티셔닝하는 이유

만약, 뉴스 프로듀서가 뉴스 토픽으로 4개의 메시지 전송(개당 1초) → 4초 걸림

 그렇다면 프로듀서를 4개로 변경하고 파티션을 1개로 유지

→ 메시징 큐에서 메시지순서가 보장되지 않음(이전 메시지 처리 이후 다음 메시지 처리함)

**[파티셔닝을 통해 해결]**

![3%202%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2049d59c2e9271411489681e5e4559c336/Untitled.png](3%202%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2049d59c2e9271411489681e5e4559c336/Untitled.png)

뉴스 토픽에 대해 파티션 수를 1개에서 4개로 늘리고, 프로듀서 수도 동일하게 4개로 늘림
→ 각 프로듀서는 하나의 메시지를 뉴스토픽의 파티션으로 보내게 됨
→ 1초 소요

> 그렇다면 무조건 파티션 수를 늘려야하나? → 아님

- 파일 핸들러의 낭비
    - 각 파티션은 브로커의 디렉토리와 매핑됨 → 모든 디렉토리의파일들에 대해 파일 핸들을 열기 때문에 파티션 수가 많아질 수록 파일 핸들도 많아져서 리소스 낭비
- 장애 복구 시간 증가
    - 각 파티션마다 리플리케이션이 동작 ( 하나가 리더, 나머지가 팔로워)
    - 만약 브로커가 다운되면, 해당 브로커에 리더가 있는 파티션은 일시적으로 사용할 수 없음

    → 리더를 팔로워 중 하나로 이동시켜 클라이언트처리

    - 이런 장애 처리를 컨트롤러로 지정된 브로커가 수행(컨트롤러는 카프카 클러스터 내 하나만 존재)
    - 리더 선출 과정에서 파티션의 수가 많아질 수록 딜레이가 많아짐
- 등등..

### 토픽의 적절한 파티션수

1. 원하는 목표 처리량의 기준을 잡는다
2. 프로듀서가 초당 보낼 수 있는 메시지 양 고려
3. 컨슈머가 초당가져올 수 있는 메시지 양 고려

카프카에서 파티션 수 늘리는것은 아무때나 변경 가능

→ BUT, 줄이는 방법은 제공하지 않음 (토픽을 지우는 것 말고는 해결책이 없음)

> 적은 수의 파티션으로 운영해보고 조금씩 늘려가는 방법으로 할당하자

# 3. 오프셋과 메시지 순서

- 오프셋 : 카프카에서 각 파티션 마다 메시지가 저장되는 위치
    - 파티션 내에서 유일함
    - 순차적으로 증가하는 숫자 형태

![3%202%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2049d59c2e9271411489681e5e4559c336/Untitled%201.png](3%202%20%E1%84%8F%E1%85%A1%E1%84%91%E1%85%B3%E1%84%8F%E1%85%A1%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%86%E1%85%A9%E1%84%83%E1%85%A6%E1%86%AF%2049d59c2e9271411489681e5e4559c336/Untitled%201.png)

그림과 같이 오프셋은 하나의 파티션 내에서만 유일한 숫자이다

- 토픽기준 → 오프셋이 0인 것이 3개
- 파티션 기준 → 오프셋 0은 유일함

→ 이 원리로 메시지 순서를 보장한다

→ 컨슈머가 파티션 0에서 데이터를 가져가려고 하면 오프셋 0,1,2... 순서대로만 가져갈 수 있음